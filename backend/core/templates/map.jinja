{% extends "base.jinja" %}

{% block heading %}
GPS Map
{% endblock %}

{% block content %}

<!-- Leaflet.js CSS & JS -->
<link rel="stylesheet" href="/static/css/leaflet.css" />
<link rel="stylesheet" href="/static/css/leaflet.fullscreen.css" />
<script src="/static/js/leaflet.js"></script>
<script src="/static/js/leaflet.fullscreen.js"></script>
<script src="/static/js/leaflet-heat.js"></script>

<style>
    #map {
        height: 600px;
        width: 100%;
        position: relative;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        display: none;
        z-index: 1000;
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .date-selector {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: center;
    }
    .date-selector button, .date-selector input {
        flex: 1 1 auto;
        min-width: 100px;
    }

    /* Simple "legend" or control area in the top-right corner */
    .map-legend {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 999;
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 12px;
        border-radius: 4px;
    }
</style>

<div class="container mt-4">
    <div class="date-selector">
        <button onclick="adjustDate(-1)">&lt;&lt;</button>
        <div>
            <input type="date" id="start-date"> to 
            <input type="date" id="end-date">
        </div>
        <button onclick="adjustDate(1)">&gt;&gt;</button>
        <button onclick="setDateRange('today')">Today</button>
        <button onclick="setDateRange('yesterday')">Yesterday</button>
        <button onclick="setDateRange('last_week')">Last Week</button>
        <button onclick="setDateRange('last_month')">Last Month</button>
        <button onclick="setDateRange('all')">All</button>
    </div>
    
    <div id="map">
        <div id="loading-spinner" class="loading-spinner"></div>

        <!-- Legend for toggling heatmap -->
        <div class="map-legend">
            <label>
                <input 
                    type="checkbox" 
                    id="toggleHeatmap" 
                    onchange="toggleHeatmap(this)" 
                />
                Enable Heatmap
            </label>
        </div>
    </div>
</div>

<script>
    var map;
    var polylineLayer;
    var markerLayer;
    var lastBounds = null;
    var fetchTimeout = null;
    var delay = 500;

    // Heatmap-related variables
    var heatLayer = null;
    var heatmapLoaded = false;  // to ensure data is only loaded once
    var heatmapData = [];       // will be filled upon fetch

    function initMap() {
        map = L.map('map').setView([{{ last_point.latitude }}, {{ last_point.longitude }}], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);

        L.control.fullscreen().addTo(map);

        polylineLayer = L.layerGroup().addTo(map);
        markerLayer = L.layerGroup().addTo(map);

        map.on('movestart', () => clearTimeout(fetchTimeout));
        map.on('moveend', () => fetchTimeout = setTimeout(fetchGPSData, delay));

        loadDateFromURL();
    }

    function updateURLParams(startDate, endDate) {
        const params = new URLSearchParams(window.location.search);
        params.set('start_date', startDate);
        params.set('end_date', endDate);
        window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
    }

    function fetchGPSData(forced = false) {
        var bounds = map.getBounds();
        if (!bounds) return;

        var zoomLevel = map.getZoom();
        var northEast = bounds.getNorthEast();
        var southWest = bounds.getSouthWest();

        // Skip fetching if the map bounds haven't changed (and not forced)
        if (!forced && lastBounds && lastBounds.equals(bounds)) return;
        lastBounds = bounds;

        document.getElementById("loading-spinner").style.display = "block";

        let startDate = document.getElementById("start-date").value;
        let endDate = document.getElementById("end-date").value;

        fetch("", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ne_lat: northEast.lat,
                ne_lng: northEast.lng,
                sw_lat: southWest.lat,
                sw_lng: southWest.lng,
                zoom: zoomLevel,
                start_date: startDate,
                end_date: endDate
            })
        })
        .then(response => response.json())
        .then(data => updateMap(data))
        .catch(error => console.error("Error fetching GPS data:", error))
        .finally(() => document.getElementById("loading-spinner").style.display = "none");
    }

    function updateMap(gpsData) {
        polylineLayer.clearLayers();
        markerLayer.clearLayers();

        if (gpsData.length === 0) return;

        var coordinates = gpsData.map(record => ({
            id: record.id,
            lat: record.lat,
            lng: record.lon,
            speed: record.s,
            altitude: record.a,
            timestamp: record.t
        }));

        // Draw polylines
        for (let i = 0; i < coordinates.length - 1; i++) {
            let color = getSpeedColor(coordinates[i].speed || 0);
            L.polyline([coordinates[i], coordinates[i + 1]], { color: color, weight: 4 }).addTo(polylineLayer);
        }

        // Add markers if zoomed in enough OR small data set
        if (map.getZoom() > 18 || coordinates.length < 500) {
            coordinates.forEach(coord => {
                let marker = L.circleMarker([coord.lat, coord.lng], {
                    radius: 5,
                    fillColor: "black",
                    color: "white",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(markerLayer);

                marker.bindPopup(`
                    <b>Timestamp:</b> ${coord.timestamp} <br>
                    <b>Speed:</b> ${coord.speed ? (coord.speed * 3.6).toFixed(2) + " km/h" : "N/A"} <br>
                    <b>Altitude:</b> ${coord.altitude ? coord.altitude.toFixed(2) + " m" : "N/A"} <br>
                    <button onclick="deletePoint(${coord.id}, this)">Delete</button>
                    <button onclick="setDateToPoint('${coord.timestamp}')">Set Date</button>
                `);
            });
        }
    }

    function adjustDate(days) {
        let startDateInput = document.getElementById("start-date");
        let endDateInput = document.getElementById("end-date");
        
        let startDate = new Date(startDateInput.value);
        let endDate = new Date(endDateInput.value);
        
        startDate.setDate(startDate.getDate() + days);
        endDate.setDate(endDate.getDate() + days);
        
        startDateInput.value = startDate.toISOString().split('T')[0];
        endDateInput.value = endDate.toISOString().split('T')[0];
        
        updateURLParams(startDateInput.value, endDateInput.value);
        fetchGPSData(true);
    }

    function setDateToPoint(timestamp) {
        let date = new Date(timestamp);
        let formattedDate = date.toISOString().split('T')[0];

        document.getElementById("start-date").value = formattedDate;
        document.getElementById("end-date").value = formattedDate;

        updateURLParams(formattedDate, formattedDate);
        fetchGPSData(true);
    }

    function getSpeedColor(speed) {
        let kph = speed * 3.6;
        // Example: color scale from green (low speed) to red (high speed)
        let hue = Math.max(0, Math.min(120 - (kph / 200) * 120, 120));
        return `hsl(${hue}, 100%, 50%)`;
    }

    function deletePoint(pointId, button) {
        fetch(`/map?id=${pointId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    map.closePopup();
                    fetchGPSData(true);
                } else {
                    alert("Failed to delete point");
                }
            })
            .catch(error => console.error("Error deleting point:", error));
    }

    function setDateRange(range) {
        let today = new Date();
        let startDate, endDate;

        if (range === 'today') {
            startDate = endDate = today;
        } else if (range === 'yesterday') {
            today.setDate(today.getDate() - 1);
            startDate = endDate = today;
        } else if (range === 'last_week') {
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            endDate = today;
        } else if (range === 'last_month') {
            startDate = new Date(today);
            startDate.setMonth(today.getMonth() - 1);
            endDate = today;
        } else if (range === 'all') {
            startDate = new Date(0);
            endDate = today;
        }

        startDate = startDate.toISOString().split('T')[0];
        endDate = endDate.toISOString().split('T')[0];

        document.getElementById("start-date").value = startDate;
        document.getElementById("end-date").value = endDate;

        updateURLParams(startDate, endDate);
        fetchGPSData(true);
    }

    function loadDateFromURL() {
        const params = new URLSearchParams(window.location.search);
        const startDate = params.get('start_date');
        const endDate = params.get('end_date');

        if (startDate && endDate) {
            document.getElementById("start-date").value = startDate;
            document.getElementById("end-date").value = endDate;
            fetchGPSData(true);
        } else {
            setDateRange('today');
        }
    }

    // ------------- HEATMAP TOGGLING -------------
    function toggleHeatmap(checkbox) {
        if (checkbox.checked) {
            // If the heatmap data has not been fetched yet, fetch it
            if (!heatmapLoaded) {
                fetchHeatmapData()
                    .then(() => {
                        // Create the heatLayer once data is available
                        heatLayer = L.heatLayer(heatmapData).addTo(map);
                        heatmapLoaded = true;
                    })
                    .catch(err => console.error("Error fetching heatmap data:", err));
            } else {
                // If already loaded before, just add it to the map
                if (heatLayer) {
                    map.addLayer(heatLayer);
                }
            }
        } else {
            // Uncheck: remove the heat layer if it exists
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
        }
    }

    // Fetch the heatmap data (only once)
    function fetchHeatmapData() {
        document.getElementById("loading-spinner").style.display = "block";
        return fetch("/map/heatmap_data.json")
            .then(response => response.json())
            .then(data => {
                heatmapData = data; // store globally
            })
            .finally(() => document.getElementById("loading-spinner").style.display = "none");
    }

    document.addEventListener("DOMContentLoaded", initMap);
</script>

{% endblock %}
